name: K6 All Tests Fixed

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  run-all-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install K6
      run: |
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
        echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install k6

    - name: Install HTML Reporter
      run: npm install -g k6-html-reporter

    - name: List test files
      id: list-tests
      run: |
        echo "Test files found:"
        find tests -name "*.js" -type f
        TEST_FILES=$(find tests -name "*.js" -type f | jq -R -s -c 'split("\n") | map(select(. != ""))')
        echo "test_files=$TEST_FILES" >> $GITHUB_OUTPUT

    - name: Create results directory
      run: mkdir -p test-results

    - name: Run all K6 tests
      id: run-tests
      run: |
        echo "🚀 Running all K6 tests from project root..."
        
        # Run each test file from the project root directory
        for test_file in tests/*.js; do
          if [ -f "$test_file" ]; then
            filename=$(basename "$test_file" .js)
            echo "▶️ Running test: $test_file"
            
            # Run from project root, not from tests directory
            k6 run "$test_file" --out json="test-results/$filename-results.json" && \
            echo "✅ PASS: $filename" || \
            echo "❌ FAIL: $filename"
            
            echo "----------------------------------------"
          fi
        done

    - name: Generate HTML reports for all tests
      run: |
        echo "📊 Generating HTML reports..."
        for file in test-results/*-results.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" -results.json)
            echo "Generating report for: $filename"
            k6-html-reporter "$file" -o "test-results/$filename-report.html"
          fi
        done

    - name: Generate Test Summary
      run: |
        echo "## 🧪 K6 Performance Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📋 Tests Executed:" >> $GITHUB_STEP_SUMMARY
        
        # Count test files
        TEST_COUNT=$(find tests -name "*.js" -type f | wc -l)
        echo "Total test files found: $TEST_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # List all test files
        for test_file in tests/*.js; do
          if [ -f "$test_file" ]; then
            filename=$(basename "$test_file" .js)
            echo "- **$filename**" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📈 Results:" >> $GITHUB_STEP_SUMMARY
        
        # Show results for each test
        for file in test-results/*-results.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file" -results.json)
            if [ -s "$file" ]; then
              total_requests=$(cat "$file" | jq -r '.metrics.http_reqs.values.count // 0')
              avg_duration=$(cat "$file" | jq -r '.metrics.http_req_duration.values.avg // 0 | round')
              success_rate=$(cat "$file" | jq -r '(.metrics.checks.values.rate // 0) * 100 | round')
              echo "- ✅ **$filename**: $total_requests reqs, ${avg_duration}ms avg, ${success_rate}% success" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ **$filename**: Test failed or no results" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 📁 Download Reports:" >> $GITHUB_STEP_SUMMARY
        echo "Download the artifacts below to view detailed HTML reports with interactive charts." >> $GITHUB_STEP_SUMMARY

    - name: Upload All HTML Reports
      uses: actions/upload-artifact@v4
      with:
        name: k6-html-reports
        path: test-results/*-report.html
        retention-days: 30

    - name: Upload All JSON Results
      uses: actions/upload-artifact@v4
      with:
        name: k6-json-results
        path: test-results/*-results.json
        retention-days: 30

    - name: Upload Test Files for Debugging
      uses: actions/upload-artifact@v4
      with:
        name: k6-test-files
        path: tests/
        retention-days: 7