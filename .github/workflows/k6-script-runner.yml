name: K6 Performance Tests

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
  
  # Trigger on push to main/master branch
  push:
    branches:
      - main
      - master
    paths:
      - 'tests/**'
      - 'config/**'
      - 'run-all-tests.js'
      - '.github/workflows/k6-script-runner.yml'
  
  # Trigger on pull request
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'tests/**'
      - 'config/**'
      - 'run-all-tests.js'
  
  # Scheduled run at 11:15 PM IST (5:45 PM UTC)
  # IST is UTC+5:30, so 11:15 PM IST = 5:45 PM UTC
  schedule:
    - cron: '45 17 * * *'

# Set permissions for uploading artifacts
permissions:
  contents: read
  actions: write
  checks: write
  pull-requests: write

jobs:
  k6-performance-tests:
    name: Run K6 Performance Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ðŸ“¦ Install Node Dependencies
        run: |
          if [ -f "package.json" ]; then
            if [ -f "package-lock.json" ]; then
              npm ci
            else
              npm install
            fi
          else
            echo "â„¹ï¸  No package.json found, skipping npm dependencies"
          fi
      
      - name: ðŸ“¥ Install K6
        run: |
          # Install k6 on Ubuntu
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
      
      - name: âœ… Verify K6 Installation
        run: k6 version
      
      - name: ðŸƒ Run All K6 Tests
        id: run_tests
        continue-on-error: true
        run: |
          echo "Starting K6 test suite..."
          node run-all-tests.js
          echo "Tests completed!"
        env:
          NODE_ENV: production
      
      - name: ðŸ“Š Generate Test Summary
        if: always()
        run: |
          echo "# K6 Performance Test Results ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check if reports directory exists
          if [ -d "reports" ]; then
            # Find the latest HTML report
            LATEST_REPORT=$(ls -t reports/test-report-*.html 2>/dev/null | head -1)
            
            if [ -f "$LATEST_REPORT" ]; then
              echo "âœ… Test reports generated successfully" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              
              # Extract summary from CSV if available
              LATEST_CSV=$(ls -t reports/test-results-*.csv 2>/dev/null | head -1)
              if [ -f "$LATEST_CSV" ]; then
                echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Test Name | Status | Duration | HTTP Requests | Avg Response Time | Success Rate |" >> $GITHUB_STEP_SUMMARY
                echo "|-----------|--------|----------|---------------|-------------------|--------------|" >> $GITHUB_STEP_SUMMARY
                tail -n +2 "$LATEST_CSV" | while IFS=',' read -r name status duration iterations requests avg_time p95_time success_rate fail_rate timestamp; do
                  # Remove quotes from fields
                  name=$(echo $name | tr -d '"')
                  echo "| $name | $status | ${duration}s | $requests | ${avg_time}ms | ${success_rate}% |" >> $GITHUB_STEP_SUMMARY
                done
              fi
            else
              echo "âš ï¸ No HTML report found" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Reports directory not found" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ðŸ“¤ Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-html-report-${{ github.run_number }}
          path: reports/test-report-*.html
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload CSV Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-csv-report-${{ github.run_number }}
          path: reports/test-results-*.csv
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload JSON Summaries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-json-summaries-${{ github.run_number }}
          path: reports/summary-*.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ“¤ Upload All Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-all-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30
          if-no-files-found: warn
      
      - name: ðŸ’¬ Comment on PR with Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ðŸš€ K6 Performance Test Results\n\n';
            comment += `**Run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})\n`;
            comment += `**Commit:** ${context.sha.substring(0, 7)}\n\n`;
            
            try {
              // Find the latest CSV report
              const reportsDir = 'reports';
              if (fs.existsSync(reportsDir)) {
                const csvFiles = fs.readdirSync(reportsDir)
                  .filter(f => f.startsWith('test-results-') && f.endsWith('.csv'))
                  .sort()
                  .reverse();
                
                if (csvFiles.length > 0) {
                  const csvPath = path.join(reportsDir, csvFiles[0]);
                  const csvContent = fs.readFileSync(csvPath, 'utf8');
                  const lines = csvContent.split('\n').filter(l => l.trim());
                  
                  if (lines.length > 1) {
                    comment += '### Test Results Summary\n\n';
                    comment += '| Test Name | Status | Duration | Requests | Avg Response | Success Rate |\n';
                    comment += '|-----------|--------|----------|----------|--------------|-------------|\n';
                    
                    let passedCount = 0;
                    let failedCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                      const parts = lines[i].split(',');
                      if (parts.length >= 8) {
                        const name = parts[0].replace(/"/g, '');
                        const status = parts[1];
                        const duration = parts[2];
                        const requests = parts[4];
                        const avgTime = parts[5];
                        const successRate = parts[7];
                        
                        const statusEmoji = status === 'PASSED' ? 'âœ…' : 'âŒ';
                        comment += `| ${name} | ${statusEmoji} ${status} | ${duration}s | ${requests} | ${avgTime}ms | ${successRate}% |\n`;
                        
                        if (status === 'PASSED') passedCount++;
                        else failedCount++;
                      }
                    }
                    
                    comment += `\n**Summary:** ${passedCount} passed, ${failedCount} failed\n`;
                  }
                }
                
                comment += '\nðŸ“Š Full reports available in workflow artifacts.';
              } else {
                comment += 'âš ï¸ No test reports were generated.\n';
              }
            } catch (error) {
              comment += `âš ï¸ Error reading test results: ${error.message}\n`;
            }
            
            // Post comment on PR
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: ðŸ” Check Test Results
        if: always()
        run: |
          if [ -d "reports" ]; then
            LATEST_CSV=$(ls -t reports/test-results-*.csv 2>/dev/null | head -1)
            if [ -f "$LATEST_CSV" ]; then
              # Check if any tests failed
              FAILED_COUNT=$(tail -n +2 "$LATEST_CSV" | grep -c ",FAILED," || true)
              if [ "$FAILED_COUNT" -gt 0 ]; then
                echo "::error::$FAILED_COUNT test(s) failed"
                exit 1
              else
                echo "::notice::All tests passed successfully!"
              fi
            else
              echo "::warning::No CSV report found"
            fi
          else
            echo "::error::Reports directory not found"
            exit 1
          fi
      
      - name: ðŸ“§ Send Notification on Failure
        if: failure() && (github.event_name == 'schedule' || github.event_name == 'push')
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            console.log(`Tests failed! Check the run at: ${runUrl}`);
            // You can integrate with Slack, Email, or other notification services here

  # Optional: Create a GitHub Pages deployment for reports
  deploy-reports:
    name: Deploy Reports to GitHub Pages
    needs: k6-performance-tests
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0
      
      - name: ðŸ“¥ Download Reports
        uses: actions/download-artifact@v4
        with:
          name: k6-all-reports-${{ github.run_number }}
          path: reports-${{ github.run_number }}
      
      - name: ðŸ“ Create Index Page
        run: |
          mkdir -p reports-${{ github.run_number }}
          cat > reports-${{ github.run_number }}/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>K6 Test Reports</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #333; }
              .report-link { margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px; }
              a { color: #0066cc; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>K6 Performance Test Reports</h1>
            <p>Run #${{ github.run_number }} - $(date)</p>
            <div class="report-link">
              <a href="test-report-$(ls test-report-*.html | head -1 | cut -d'-' -f3-)">View HTML Report</a>
            </div>
          </body>
          </html>
          EOF
      
      - name: ðŸš€ Commit and Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add reports-${{ github.run_number }}
          git commit -m "Add test reports for run #${{ github.run_number }}" || echo "No changes to commit"
          git push origin gh-pages || echo "Push failed"